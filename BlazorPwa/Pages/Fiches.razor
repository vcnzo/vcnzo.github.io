@page "/fiches"
@using BlazorPwa.Models
@using BlazorPwa.Services
@inject StudyService StudyService
@inject NavigationManager NavManager

<div class="animate-fade-in">
    <header style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
        <div>
            <h1 style="font-size: 1.5rem; margin-bottom: 0.25rem;">Flashcards</h1>
            @if (SelectedSubject != null)
            {
                <span style="font-size: 0.875rem; color: @SelectedSubject.Color; font-weight: 600;">@SelectedSubject.Name</span>
            }
            else
            {
                <span style="font-size: 0.875rem; color: var(--text-secondary);">Toutes les matières</span>
            }
        </div>
        @if (SelectedSubject != null)
        {
            <button class="btn" style="padding: 0.5rem; background: rgba(255,255,255,0.1); color: white;" @onclick="ClearFilter">
                ✕
            </button>
        }
    </header>

    @if (!Flashcards.Any())
    {
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            Aucune fiche trouvée.
        </div>
    }
    else
    {
        <div style="display: grid; gap: 1.5rem;">
            @foreach (var group in Flashcards.GroupBy(f => f.Theme))
            {
                <div>
                    <h3 style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">@group.Key</h3>
                    <div style="display: grid; gap: 0.75rem;">
                        @foreach (var card in group)
                        {
                            <div class="card" style="margin-bottom: 0; padding: 1.25rem; cursor: pointer; position: relative; overflow: hidden;" @onclick="() => FlipCard(card)">
                                <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 1.1rem;">@card.Question</div>
                                @if (RevealedCards.Contains(card.Id))
                                {
                                    <div style="color: var(--primary); border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.75rem; margin-top: 0.75rem;" class="animate-fade-in">
                                        @card.Answer
                                    </div>
                                }
                                else
                                {
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 0.5rem; opacity: 0.7;">
                                        Toucher pour voir la réponse
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public Guid? SubjectId { get; set; }

    private List<Flashcard> Flashcards = new();
    private Subject? SelectedSubject;
    private HashSet<Guid> RevealedCards = new();

    protected override void OnParametersSet()
    {
        if (SubjectId.HasValue)
        {
            SelectedSubject = StudyService.GetSubject(SubjectId.Value);
            Flashcards = StudyService.GetFlashcards(SubjectId.Value);
        }
        else
        {
            SelectedSubject = null;
            Flashcards = StudyService.GetSubjects().SelectMany(s => StudyService.GetFlashcards(s.Id)).ToList();
        }
        RevealedCards.Clear();
    }

    private void ClearFilter()
    {
        NavManager.NavigateTo("fiches");
    }

    private void FlipCard(Flashcard card)
    {
        if (RevealedCards.Contains(card.Id))
            RevealedCards.Remove(card.Id);
        else
            RevealedCards.Add(card.Id);
    }
}
