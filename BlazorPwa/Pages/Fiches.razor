@page "/fiches"
@using BlazorPwa.Models
@using BlazorPwa.Services
@inject StudyService StudyService
@inject NavigationManager NavManager

<div class="fiches-container">
    <header class="header">
        <h1>Mes Fiches</h1>
        <button class="btn btn-primary btn-sm" @onclick="CreateNew">
            <span>+</span> Nouvelle
        </button>
    </header>

    <div class="fiches-grid">
        @foreach (var sheet in Sheets)
        {
            var subject = StudyService.GetSubject(sheet.SubjectId);
            <div class="fiche-card" @onclick="() => OpenSheet(sheet.Id)">
                <div class="card-header">
                    <span class="subject-badge" style="background-color: @(subject?.Color ?? "#ccc")">
                        @(subject?.Name ?? "Autre")
                    </span>
                    <span class="date">@sheet.CreatedAt.ToString("dd/MM")</span>
                </div>
                <h3>@sheet.Title</h3>
                <p class="theme">@sheet.Theme</p>
                <div class="preview">
                    @((MarkupString)(sheet.Content.Length > 50 ? sheet.Content.Substring(0, 50) + "..." : sheet.Content))
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<RevisionSheet> Sheets = new();

    protected override void OnInitialized()
    {
        Sheets = StudyService.GetSheets();
    }

    private void CreateNew()
    {
        NavManager.NavigateTo("/fiches/new");
    }

    private void OpenSheet(Guid id)
    {
        // For now, just edit mode or view mode. Let's go to edit for simplicity or view.
        // Implementing View later if needed, for now let's assume we can edit/view in same place or just list them.
        // Let's just show a "Not implemented view" or go to editor.
        NavManager.NavigateTo($"/fiches/edit/{id}");
    }
}

<style>
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    .fiches-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); /* Full width on mobile */
        gap: 1rem;
    }
    .fiche-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid #F1F5F9;
        cursor: pointer;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    .subject-badge {
        color: white;
        padding: 0.1rem 0.5rem;
        border-radius: var(--radius-sm);
        font-size: 0.7rem;
        font-weight: 600;
    }
    .date {
        font-size: 0.7rem;
        color: var(--color-text-muted);
    }
    .fiche-card h3 {
        font-size: 1.1rem;
        margin: 0.25rem 0;
        color: var(--color-primary-dark);
    }
    .theme {
        font-size: 0.85rem;
        color: var(--color-accent);
        margin-bottom: 0.5rem;
    }
    .preview {
        font-size: 0.8rem;
        color: var(--color-text-muted);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
