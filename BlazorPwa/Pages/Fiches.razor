@page "/fiches"
@using BlazorPwa.Models
@using BlazorPwa.Services
@inject StudyService StudyService
@inject NavigationManager NavManager

<div class="animate-fade-in">
    <header style="display: flex; align-items: center; margin-bottom: 2rem;">
        <div style="font-size: 2.5rem; margin-right: 1rem;">üóÇÔ∏è</div>
        <div>
            @if (SelectedSubject != null)
            {
                <h1 style="font-size: 2rem; font-weight: 800; color: white; margin: 0; line-height: 1.1;">@SelectedSubject.Name</h1>
            }
            else
            {
                <h1 style="font-size: 2rem; font-weight: 800; color: white; margin: 0; line-height: 1.1;">Toutes les mati√®res</h1>
            }
        </div>
    </header>

    @if (!Flashcards.Any())
    {
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            Aucune fiche trouv√©e.
        </div>
    }
    else
    {
        <div style="display: grid; gap: 1rem;">
            @foreach (var group in Flashcards.GroupBy(f => f.Theme))
            {
                var isExpanded = ExpandedThemes.Contains(group.Key);
                var themeId = "theme-" + Math.Abs(group.Key.GetHashCode());
                var subjectId = group.First().SubjectId;
                var subject = StudyService.GetSubject(subjectId);
                var color = subject?.Color ?? "var(--primary)";
                
                <div style="background: var(--surface); border-radius: var(--radius-md); overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
                    <div id="@themeId" @onclick="() => ToggleTheme(group.Key, themeId)" 
                         style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; 
                                background: linear-gradient(90deg, @(color)1A 0%, rgba(255,255,255,0.02) 100%);
                                border-left: 4px solid @color;">
                        <h3 style="font-size: 0.9rem; color: var(--text); font-weight: 600; margin: 0;">@group.Key</h3>
                        <span style="transform: rotate(@(isExpanded ? "180deg" : "0deg")); transition: transform 0.3s ease;">‚ñº</span>
                    </div>
                    
                    @if (isExpanded)
                    {
                        <div style="padding: 1rem; display: grid; gap: 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
                            @foreach (var card in group)
                            {
                                var result = GetCardResult(card.Id);
                                var isFlipped = RevealedCards.Contains(card.Id);
                                var cardStyle = "margin-bottom: 0; position: relative;";
                                var frontStyle = "background: var(--surface-light);";
                                
                                if (result.HasValue)
                                {
                                    frontStyle = result.Value 
                                        ? "background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);" 
                                        : "background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3);";
                                }

                                <div style="flex: 1; perspective: 1000px; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem;">
                                    <div class="quiz-card @(isFlipped ? "flipped" : "")" @onclick="() => FlipCard(card)">
                                        <div class="quiz-card-face quiz-card-front" style="@frontStyle">
                                            <span class="theme-badge">@card.Theme</span>
                                            <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.4;">@card.Question</div>
                                            <div style="margin-top: auto; font-size: 0.875rem; color: var(--text-secondary); opacity: 0.8;">
                                                Toucher pour retourner
                                            </div>
                                        </div>
                                        <div class="quiz-card-face quiz-card-back">
                                            <span class="subject-badge">@GetSubjectName(card.SubjectId)</span>
                                            <div style="font-size: 1.25rem; line-height: 1.5; margin-bottom: 1.5rem;">@card.Answer</div>
                                            
                                            <div style="display: flex; gap: 1rem; justify-content: center;" @onclick:stopPropagation="true">
                                                <button class="btn" style="width: 60px; height: 60px; border-radius: 50%; background: #ef4444; color: white; font-size: 1.5rem; padding: 0;" @onclick="()  => RateCard(card, false)">
                                                    ‚úï
                                                </button>
                                                <button class="btn" style="width: 60px; height: 60px; border-radius: 50%; background: #10b981; color: white; font-size: 1.5rem; padding: 0;" @onclick="() => RateCard(card, true)">
                                                    ‚úì
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@implements IDisposable

@inject IJSRuntime JS

@code {
    [SupplyParameterFromQuery]
    public string? SubjectId { get; set; }

    private List<Flashcard> Flashcards = new();
    private Subject? SelectedSubject;
    private HashSet<Guid> RevealedCards = new();
    private HashSet<string> ExpandedThemes = new();

    protected override void OnInitialized()
    {
        StudyService.OnChange += HandleChange;
    }

    public void Dispose()
    {
        StudyService.OnChange -= HandleChange;
    }

    private void HandleChange()
    {
        LoadData();
        StateHasChanged();
    }

    protected override void OnParametersSet()
    {
        LoadData();
        RevealedCards.Clear();
        ExpandedThemes.Clear();
    }

    private void LoadData()
    {
        if (!string.IsNullOrEmpty(SubjectId))
        {
            SelectedSubject = StudyService.GetSubject(SubjectId);
            Flashcards = StudyService.GetFlashcards(SubjectId);
        }
        else
        {
            SelectedSubject = null;
            Flashcards = StudyService.GetSubjects().SelectMany(s => StudyService.GetFlashcards(s.Id)).ToList();
        }
    }

    private string GetSubjectName(string subjectId)
    {
        var subject = StudyService.GetSubject(subjectId);
        return subject?.Name ?? "";
    }

    private void ClearFilter()
    {
        NavManager.NavigateTo("fiches");
    }

    private void FlipCard(Flashcard card)
    {
        if (RevealedCards.Contains(card.Id))
            RevealedCards.Remove(card.Id);
        else
            RevealedCards.Add(card.Id);
    }

    private async Task ToggleTheme(string theme, string elementId)
    {
        if (ExpandedThemes.Contains(theme))
        {
            ExpandedThemes.Remove(theme);
        }
        else
        {
            ExpandedThemes.Add(theme);
            // Small delay to allow rendering
            await Task.Delay(100);
            await JS.InvokeVoidAsync("scrollToElement", elementId, true);
        }
    }

    private async Task RateCard(Flashcard card, bool success)
    {
        await StudyService.RecordFlashcardResult(card.Id, success);
        RevealedCards.Remove(card.Id); // Unflip card
        StateHasChanged(); // Force update to show new color
    }

    private bool? GetCardResult(Guid guidId)
    {
        var progress = StudyService.GetProgress();
        if (progress.FlashcardResults.TryGetValue(guidId, out bool success))
        {
            return success;
        }
        return null;
    }
}
