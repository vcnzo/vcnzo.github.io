@page "/fiches"
@using BlazorPwa.Models
@using BlazorPwa.Services
@inject StudyService StudyService
@inject NavigationManager NavManager

<div class="animate-fade-in">
    <header style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
        <div>
            <h1 style="font-size: 1.5rem; margin-bottom: 0.25rem;">Flashcards</h1>
            @if (SelectedSubject != null)
            {
                <span style="font-size: 0.875rem; color: var(--text-secondary);">@SelectedSubject.Name</span>
            }
            else
            {
                <span style="font-size: 0.875rem; color: var(--text-secondary);">Toutes les matières</span>
            }
        </div>
        @* @if (SelectedSubject != null)
        {
            <button class="btn" style="padding: 0.5rem; background: rgba(255,255,255,0.1); color: white;" @onclick="ClearFilter">
                ✕
            </button>
        } *@
    </header>

    @if (!Flashcards.Any())
    {
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            Aucune fiche trouvée.
        </div>
    }
    else
    {
        <div style="display: grid; gap: 1rem;">
            @foreach (var group in Flashcards.GroupBy(f => f.Theme))
            {
                var isExpanded = ExpandedThemes.Contains(group.Key);
                <div style="background: var(--surface); border-radius: var(--radius-md); overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
                    <div @onclick="() => ToggleTheme(group.Key)" 
                         style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: rgba(255,255,255,0.02);">
                        <h3 style="font-size: 0.9rem; color: var(--text); font-weight: 600; margin: 0;">@group.Key</h3>
                        <span style="transform: rotate(@(isExpanded ? "180deg" : "0deg")); transition: transform 0.3s ease;">▼</span>
                    </div>
                    
                    @if (isExpanded)
                    {
                        <div style="padding: 1rem; display: grid; gap: 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
                            @foreach (var card in group)
                            {
                                <div id="card-@card.Id" class="card flashcard-item" style="margin-bottom: 0; padding: 1.25rem; cursor: pointer; position: relative; overflow: hidden; background: var(--surface-light);" @onclick="() => FlipCard(card)">
                                    <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 1.1rem;">@card.Question</div>
                                    @if (RevealedCards.Contains(card.Id))
                                    {
                                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.75rem; margin-top: 0.75rem;" class="animate-fade-in">
                                            <div style="color: var(--primary); margin-bottom: 1rem;">@card.Answer</div>
                                            
                                            <div style="display: flex; gap: 0.5rem; justify-content: center;" @onclick:stopPropagation="true">
                                                <button class="btn" style="width: 80px; background: #ef4444; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;" @onclick="()  => RateCard(card, false)">
                                                    ✕
                                                </button>
                                                <button class="btn" style="width: 80px; background: #10b981; color: white; padding: 0.5rem 1rem; font-size: 0.9rem;" @onclick="() => RateCard(card, true)">
                                                    ✓
                                                </button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 0.5rem; opacity: 0.7;">
                                            Toucher pour voir la réponse
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@implements IDisposable

@inject IJSRuntime JS

@code {
    [SupplyParameterFromQuery]
    public string? SubjectId { get; set; }

    private List<Flashcard> Flashcards = new();
    private Subject? SelectedSubject;
    private HashSet<Guid> RevealedCards = new();
    private HashSet<string> ExpandedThemes = new();

    protected override void OnInitialized()
    {
        StudyService.OnChange += HandleChange;
    }

    public void Dispose()
    {
        StudyService.OnChange -= HandleChange;
    }

    private void HandleChange()
    {
        LoadData();
        StateHasChanged();
    }

    protected override void OnParametersSet()
    {
        LoadData();
        RevealedCards.Clear();
        ExpandedThemes.Clear();
    }

    private void LoadData()
    {
        if (!string.IsNullOrEmpty(SubjectId))
        {
            SelectedSubject = StudyService.GetSubject(SubjectId);
            Flashcards = StudyService.GetFlashcards(SubjectId);
        }
        else
        {
            SelectedSubject = null;
            Flashcards = StudyService.GetSubjects().SelectMany(s => StudyService.GetFlashcards(s.Id)).ToList();
        }
    }

    private void ClearFilter()
    {
        NavManager.NavigateTo("fiches");
    }

    private void FlipCard(Flashcard card)
    {
        if (RevealedCards.Contains(card.Id))
            RevealedCards.Remove(card.Id);
        else
            RevealedCards.Add(card.Id);
    }

    private void ToggleTheme(string theme)
    {
        if (ExpandedThemes.Contains(theme))
            ExpandedThemes.Remove(theme);
        else
            ExpandedThemes.Add(theme);
    }

    private async Task RateCard(Flashcard card, bool success)
    {
        await StudyService.RecordFlashcardResult(card.Id, success);
        RevealedCards.Remove(card.Id);
        // Small delay to let the UI update (collapse card) before scrolling
        await Task.Delay(50);
        await JS.InvokeVoidAsync("scrollToNextCard", card.Id.ToString());
    }
}
