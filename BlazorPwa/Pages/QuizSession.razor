@page "/quiz"
@page "/quiz/{SubjectId:guid}"
@using BlazorPwa.Models
@using BlazorPwa.Services
@inject StudyService StudyService
@inject NavigationManager NavManager

<div class="animate-fade-in" style="height: 100%; display: flex; flex-direction: column;">
    @if (IsLoading)
    {
        <div style="flex: 1; display: flex; justify-content: center; align-items: center;">
            <div class="spinner"></div>
        </div>
    }
    else if (Flashcards.Count == 0)
    {
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸ“­</div>
            <h3 style="margin-bottom: 0.5rem;">Aucune carte</h3>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Il n'y a pas encore de questions disponibles.</p>
            <button class="btn btn-primary" @onclick="GoBack">Retour</button>
        </div>
    }
    else if (IsFinished)
    {
        <div class="animate-fade-in" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2rem;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">ðŸŽ‰</div>
            <h2 style="margin-bottom: 0.5rem;">Session terminÃ©e !</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Tu as rÃ©visÃ© @Flashcards.Count cartes.</p>
            
            <div style="display: grid; gap: 1rem; width: 100%; max-width: 300px;">
                <button class="btn btn-primary" @onclick="Restart">Recommencer</button>
                <button class="btn" style="background: rgba(255,255,255,0.1);" @onclick="GoBack">Retour Ã  l'accueil</button>
            </div>
        </div>
    }
    else
    {
        <div style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);">
                    Question @(CurrentIndex + 1) / @Flashcards.Count
                </span>
                <span style="font-size: 0.875rem; color: @(CurrentSubject?.Color ?? "var(--primary)"); font-weight: 600;">
                    @(CurrentSubject?.Name ?? "Quiz AlÃ©atoire")
                </span>
            </div>
            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                <div style="height: 100%; background: var(--gradient-primary); width: @(ProgressPercentage)%; transition: width 0.3s ease;"></div>
            </div>
        </div>

        <div style="flex: 1; perspective: 1000px; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem;">
            <div class="quiz-card @(IsFlipped ? "flipped" : "")" @onclick="FlipCard">
                <div class="quiz-card-face quiz-card-front">
                    <span class="subject-badge-top">@GetSubjectName(CurrentCard)</span>
                    <span class="theme-badge">@CurrentCard.Theme</span>
                    <div style="font-size: 1.5rem; font-weight: 600; line-height: 1.4;">@CurrentCard.Question</div>
                    <div class="card-instruction">
                        Toucher pour retourner
                    </div>
                </div>
                <div class="quiz-card-face quiz-card-back">
                    <span class="subject-badge">@GetSubjectName(CurrentCard)</span>
                    <div style="font-size: 1.25rem; line-height: 1.5;">@CurrentCard.Answer</div>
                </div>
            </div>
        </div>

        <div style="height: 80px; display: flex; gap: 1rem; justify-content: center; align-items: flex-end;">
            @if (IsFlipped)
            {
                <button class="btn animate-fade-in" style="flex: 1; background: #ef4444; color: white;" @onclick="NextCard">
                    Je ne savais pas
                </button>
                <button class="btn animate-fade-in" style="flex: 1; background: #10b981; color: white;" @onclick="NextCard">
                    Je savais !
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string? SubjectId { get; set; }
    
    private Subject? CurrentSubject;
    private List<Flashcard> Flashcards = new();
    private int CurrentIndex = 0;
    private bool IsFlipped = false;
    private bool IsFinished = false;
    private bool IsLoading = true;

    private Flashcard CurrentCard => Flashcards[CurrentIndex];
    private double ProgressPercentage => (double)(CurrentIndex + 1) / Flashcards.Count * 100;

    protected override async Task OnParametersSetAsync()
    {
        IsLoading = true;
        // Simulate small delay for smooth transition if needed or just ensure data is loaded
        await Task.Delay(100); 

        if (!string.IsNullOrEmpty(SubjectId))
        {
            CurrentSubject = StudyService.GetSubject(SubjectId);
            Flashcards = StudyService.GetFlashcards(SubjectId);
            // Shuffle for specific subject too? Maybe not, keep order or shuffle? Let's shuffle.
            Flashcards = Flashcards.OrderBy(x => Guid.NewGuid()).ToList();
        }
        else
        {
            CurrentSubject = null;
            // Random quiz: take all flashcards and shuffle
            var allCards = StudyService.GetSubjects().SelectMany(s => StudyService.GetFlashcards(s.Id)).ToList();
            Flashcards = allCards.OrderBy(x => Guid.NewGuid()).Take(20).ToList(); // Limit to 20 for random quiz
        }
        
        CurrentIndex = 0;
        IsFinished = false;
        IsFlipped = false;
        IsLoading = false;
    }

    private void FlipCard()
    {
        IsFlipped = !IsFlipped;
    }

    private void NextCard()
    {
        IsFlipped = false;
        if (CurrentIndex < Flashcards.Count - 1)
        {
            // Small delay to allow flip back animation if we wanted, but instant is snappier for drilling
            CurrentIndex++;
        }
        else
        {
            IsFinished = true;
        }
    }

    private void Restart()
    {
        OnParametersSetAsync();
    }

    private void GoBack()
    {
        NavManager.NavigateTo("/");
    }

    private string GetSubjectName(Flashcard card)
    {
        var subject = StudyService.GetSubject(card.SubjectId);
        return subject?.Name ?? "";
    }
}


